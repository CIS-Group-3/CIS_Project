<!DOCTYPE html>
<html lang = "en">
<head>
	<meta charset = "UTF-8">
  	<title> COVID </title>
    <link rel="stylesheet" href="covid.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--for map-->
    <script src="mapdata.js"></script>
    <script src="usmap.js"></script>
    <script src="select.js"></script>
    <!--for chart-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!--for datepicker-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  	
</head>
<body>
    <div id="container">
        <div id="tab-holder">
            <div class="row">
                <div class="col">
                    <ul class="nav nav-tabs nav-fill">
                        <li class="nav-item">
                        <a class="nav-link" href="./index.html" data-toggle="tab">Home/ Login</a>
                        </li>
                        <li class="nav-item">
                        <a class="nav-link active" href="./covid.html" data-toggle="tab">COVID</a>
                        </li>
                        <li class="nav-item">
                        <a class="nav-link" href="./unemployment.html" data-toggle="tab">Unemployment</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#placeholder" data-toggle="tab">Stock Market</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#placeholder" data-toggle="tab">Crime</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#placeholder" data-toggle="tab">CPI</a>
                        </li>
                        <li class="nav-item" style="width:30px !important;" >
                            <a class="nav-link" href="#placeholder" data-toggle="tab">
                                <img style="width:25px;" src="./profileicon.png" alt="Profile Icon" title="icon">
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="side-area">
            <div id="option-holder">
                <br>
                <div id="instructions">Select state(s), time range, and age range (optional) to view the charts.</div>
                
                <div id="dateArea">                
                    <div id="startDate">
                        <label for="startDatePicker" style="float:left">From:</label>
                        <input style="float:right; width:160px" type="text" class="form-control" id="startDatePicker" aria-label="Start Date" readonly>
                    </div>
                    <div id="endDate">
                        <label for="endDatePicker" style="float:left">To:</label>
                        <input style="float:right; width:160px" type="text" class="form-control" id="endDatePicker" aria-label="End Date" readonly>
                    </div>

                </div>
                <div id="ageArea">
                    <label for="dropdown" style="float:left">Select Age Range:</label>
                    <select id="dropdown" aria-label="Select Age Range">
                        <option value="null" style="color: gray;">Select</option>
                        <option value="0-24">0-24</option>
                        <option value="25-34">25-34</option>
                        <option value="35-44">35-44</option>
                        <option value="45-54">45-54</option>
                        <option value="55-64">55-64</option>
                        <option value="65-74">65-74</option>
                        <option value="75-84">75-84</option>
                        <option value="85+">85+</option>
                    </select>
                    
                </div>
            </div>

            <div id="my-map-holder">
                <div id="map"></div>
            </div>
        </div>

        <div id="chart-area">
            <div class="chart-holder">
                <canvas class="chart" id="myChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/en-gb.min.js"></script>


    <script>
        var data;
        var startMonth;
        var startYear;
        var endMonth;
        var endYear;
        var ageRange;

        var sharedStates=[];

        var placeholder = document.getElementById('myChart');
        var myChart = placeholder.getContext('2d');

        var statesChart;
        var ageChart;

        const dropdown = document.getElementById('dropdown');
        var selectedAgeRange = null;

        $(document).ready(function(){
            var minDate = new Date(2019, 12, 31);
            var maxDate = new Date(2023, 12, 31);

            $('#startDatePicker').datepicker({
                format: "MM yyyy",
                startView: "months", 
                minViewMode: "months",
                autoclose: true,
                startDate: minDate,
                endDate: maxDate,
                }).on('changeDate', function(e){
                        if ($('#endDatePicker').datepicker('getDate') != null && sharedStates.length >=1){

                            var startDate = $('#startDatePicker').datepicker('getDate');
                            var endDate = $('#endDatePicker').datepicker('getDate');
                            if (startDate >= endDate) {
                                alert("Start date must be before end date.");
                                // Reset the start date to the previous value
                                $(this).val('');
                            } else {
                                if (sharedStates.length >=1){ //state(s) selected
                                    fillChart();
                                }
                            }
                        }
                    });
                
            $('#endDatePicker').datepicker({
                format: "MM yyyy",
                startView: "months", 
                minViewMode: "months",
                autoclose: true,
                startDate: minDate,
                endDate: maxDate,
                }).on('changeDate', function(e){
                        if ($('#startDatePicker').datepicker('getDate') != null){

                            var startDate = $('#startDatePicker').datepicker('getDate');
                            var endDate = $('#endDatePicker').datepicker('getDate');
                            if (startDate >= endDate) {
                                alert("Start date must be before end date.");
                                // Reset the start date to the previous value
                                $(this).val('');
                            } else {
                                if (sharedStates.length >=1){ //state(s) selected
                                    fillChart();
                                }
                            }
                        }
                    });
            dropdown.addEventListener('change', function() {
            // Get the selected age range or set to null if 'Select' option is chosen
            selectedAgeRange = this.value !== 'Select' ? this.value : null;
            // Update the chart if there are selected states
            if (sharedStates.length >= 1) {
                fillChart();
            }
        });
    });

        //show chart
        async function fillChart(){
            try{
                startDate = $('#startDatePicker').datepicker('getDate');
                endDate = $('#endDatePicker').datepicker('getDate');

                startMonth = startDate.getMonth() + 1;
                startYear = startDate.getFullYear();
                endMonth = endDate.getMonth() + 1;
                endYear = endDate.getFullYear();

                await fetchData();

                if (!data || !data.rows) {
                    console.error('No valid data received');
                    return; // Exit if no data is available
                }

                placeholder.style.display = 'block'; //make chart visible if needed.

                let stateDataset = {};
                let ageDataset = {};

                stateDataset["states"] = {
                    label: "states",
                    data: [],
                    backgroundColor: `rgba(0, 0, 0, 0)`, // Random color for each dataset
                    borderColor: `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`, // Random color for each dataset
                    borderWidth: 2
                };

                ageDataset["ageRange"] = {
                    label: "ageRange",
                    data: [],
                    backgroundColor: `rgba(0, 0, 0, 0)`, // Random color for each dataset
                    borderColor: `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`, // Random color for each dataset
                    borderWidth: 2
                };

                var uniqueMonths = [];

                data.rows.forEach(row => {
                    const month = row[0];
                    const year = row[1];
                    const states = row[2];
                    const ageRange = row[3];

                    const monthyear = `${month}/${year}`;
                    if (!uniqueMonths.includes(monthyear)) {
                        uniqueMonths.push(monthyear);
                    }

                    stateDataset["states"].data.push({
                        x: `${month}/${year}`,
                        y: states
                    });

                    ageDataset["ageRange"].data.push({
                        x: `${month}/${year}`,
                        y: ageRange
                    });
                });

                const datasetsArray = Object.values(stateDataset);
                const datasetsArray1 = Object.values(ageDataset);
                
                if (selectedAgeRange) {
                    if (ageChart) {
                        // Update chart data and options
                        ageChart.data.labels = uniqueMonths;
                        ageChart.data.datasets = datasetsArray1;
                        ageChart.update();
                    } else {
                        // Create a new chart
                        ageChart = new Chart(myChart, {
                            type: 'line',
                            data: {
                                labels: uniqueMonths,
                                datasets: datasetsArray1
                            },
                            options: {
                                height: 700,
                                width: 500,
                                elements:{point:{radius: 1}}},  //remove data point circles
                                scales: {
                                xAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Time' // Specify your x axis label here
                                    }
                                }],
                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Total Deaths by State & Age' // Specify your y axis label here
                                    }
                                }]
                            }
                        });
                    }
                } else {
                    if (statesChart) {
                        // Update chart data and options
                        statesChart.data.labels = uniqueMonths;
                        statesChart.data.datasets = datasetsArray;
                        statesChart.update();
                    } else {
                        // Create a new chart
                        statesChart = new Chart(myChart, {
                            type: 'line',
                            data: {
                                labels: uniqueMonths,
                                datasets: datasetsArray
                            },
                            options: {
                                height: 700,
                                width: 500,
                                elements:{point:{radius: 1}}},  //remove data point circles
                                scales: {
                                xAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Time' // Specify your x axis label here
                                    }
                                }],
                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Total Deaths by State' // Specify your y axis label here
                                    }
                                }]
                            }
                        });
                    }
                }

            } catch (error) {
                console.error('Error filling chart:', error);
            }               
        }
        
        async function updateChart() {
            // Fetch the data and update the chart only if dates are selected
            if ($('#startDatePicker').datepicker('getDate') && $('#endDatePicker').datepicker('getDate')) {
                await fillChart();
            }
            else {
                placeholder.style.display = 'none';
            }
        }

        async function fetchData() {
            try {
                const response = await fetch('/data.json');
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(data);
            } catch (error) {
                console.error('Error fetching data covid.html:', error);
                alert("Failed to fetch data: " + error.message);
            }
        }
        
        // Function to fetch data from the server and display it in the table
        // async function fetchData() {
        //     try {
        //         sharedString = encodeURIComponent(JSON.stringify(sharedStates));  // Encode the sharedStates for URL
        //         selectedAgeRange = selectedAgeRange ? encodeURIComponent(selectedAgeRange) : 'null';  // Encode the age range or use 'null' string
        //         const url = `/covid?sm=${startMonth}&sy=${startYear}&em=${endMonth}&ey=${endYear}&states=${sharedString}&ageRange=${selectedAgeRange}`;

        //         const response = await fetch(url);
        //         if (!response.ok) {
        //             throw new Error(`HTTP error! status: ${response.status}`);
        //         }

        //         const text = await response.text();
        //         data = JSON.parse(text);

        //     } catch(error) {
        //         console.error('Error fetching data covid.html:', error);
        //         // It's good practice to also display an error message in the UI
        //         alert("Failed to fetch data: " + error.message);
        //     }
        // }

        function writeSharedStates(state){
            sharedStates.push(state);
            fillChart();
        }

        function removeSharedStates(state){
            const index = sharedStates.indexOf(state);
            if (index != -1) {
                sharedStates.splice(index, 1);
            }
            
            if (sharedStates.length >= 1) {
                fillChart();
            }
            else{ 
                placeholder.style.display = 'none';
            }
        }

        function generateColors(numColors) {
            const colors= [];
            const hueStep = 360 / numColors;
            for (let i = 0; i < numColors; i++) {
                const hue = (hueStep * i) % 360;
                const saturation= 10 + Math.random() * 90; // Vary between 10% - 100%
                const lightness= 20 + Math.random() * 60; // Vary lightness from 20% - 80%
                colors.push(`hsl(${hue},${saturation}%,${lightness}%)`);
            }
            return colors;
        }

        // List of state names
        const stateNames = [
            'Alabama', 'Alaska', 'Arizona','Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia',
            'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland',
            'Massachusetts','Michigan', 'Minnesota','Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
            'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania',
            'Rhode Island', 'South Carolina','South Dakota','Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington',
            'West Virginia','Wisconsin','Wyoming'
        ];

        // Generate distinct colors
        const colors = generateColors(stateNames.length);

        // Generate state colors object
        const stateColors = {};
        for (let i = 0; i < stateNames.length; i++) {
            stateColors[stateNames[i]]=colors[i];
        }

    </script>
</body>

</html>