<!DOCTYPE html>
<html lang = "en">
<head>
	<meta charset = "UTF-8">
  	<title> Crime Rate </title>
    <link rel="stylesheet" href="crimerate.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--for chart-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!--for datepicker-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  <!--for tabs-->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  	
</head>
<body>
    <div id="container">
        <div id="tab-holder">
            <div class="row">
                <div class="col">
                    <ul class="nav nav-tabs nav-fill">
                        <li class="nav-item">
                        <a class="nav-link" href="./index.html" data-toggle="tab">Welcome</a>
                        </li>
                        <li class="nav-item">
                        <a class="nav-link" href="#placeholder" data-toggle="tab">COVID</a>
                        </li>
                        <li class="nav-item">
                        <a class="nav-link" href="./unemployment.html" data-toggle="tab">Unemployment</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./DJIndex.html" data-toggle="tab">Stock Market</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="./crimerate.html" data-toggle="tab">Crime</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./inflation.html" data-toggle="tab">CPI</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div id="option-holder">
            <br>
            <div id="instructions">This chart shows the correlation between unemployment in California and theft/stealing related crimes in different areas of Los Angeles over the period of time COVID was most prominent. </div>
            <br>
            <div id="time-range">Select a time range between 2020 - 2022 and an area in Los Angeles to view the chart.</div>
            <br>
            <div id="dateArea">                
                <div id="startDate">
                    Select start date:
                      <input type="text" class="form-control" id="startDatePicker" readonly>
                </div>
                <div id="endDate">
                    Select end date:
                      <input type="text" class="form-control" id="endDatePicker" readonly>
                </div>
            </div>
            <div id="conditionArea">
                <div style="float:left">Select Area:</div>
                <select id="dropdown">
                    <option value="null" style="color: gray;">Select</option>
                    <option value="All Areas">All Areas</option>
                    <option value="Devonshire">Devonshire</option>
                    <option value="Northeast">Northeast</option>
                    <option value="Harbor">Harbor</option>
                    <option value="Olympic">Olympic</option>
                    <option value="Hollywood">Hollywood</option>
                    <option value="Pacific">Pacific</option>
                    <option value="Van Nuys">Van Nuys</option>
                    <option value="77th Street">77th Street</option>
                    <option value="Foothill">Foothill</option>
                    <option value="Central">Central</option>
                    <option value="West LA">West LA</option>
                    <option value="Hollenbeck">Hollenbeck</option>
                    <option value="Mission">Mission</option>
                    <option value="Rampart">Rampart</option>
                    <option value="Southwest">Southwest</option>
                    <option value="West Valley">West Valley</option>
                    <option value="Wilshire">Wilshire</option>
                    <option value="N Hollywood">N Hollywood</option>
                    <option value="Southeast">Southeast</option>
                    <option value="Topanga">Topanga</option>
                    <option value="Newton">Newton</option>
                </select>
                  
            </div>
        </div>
        <div id="chart-holder">
            <canvas id="myChart"></canvas>
        </div>
        <div id ="chart1-holder">   
            <canvas id ="myChart1"></canvas>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/en-gb.min.js"></script>


    <script>
        var data;
        var startMonth;
        var startYear;
        var endMonth;
        var endYear;

        var sharedStates=[];

        var placeholder = document.getElementById('myChart');
        var myChart = placeholder.getContext('2d');

        var placeholder1 = document.getElementById('myChart1');
        var myChart1 = placeholder1.getContext('2d');

        var lineChart;
        var lineChart1; 

        const dropdown = document.getElementById('dropdown');
        var selectedArea ='null';

        dropdown.addEventListener('change', function() {
            ensureSelected();
        });
    
        function ensureSelected(){
            console.log("ensure called");
            selectedArea = dropdown.value;
            console.log("selected: "+selectedArea);

            if ($('#startDatePicker').datepicker('getDate') != null && $('#endDatePicker').datepicker('getDate') != null){

                var startDate = $('#startDatePicker').datepicker('getDate');
                var endDate = $('#endDatePicker').datepicker('getDate');
                if (startDate >= endDate) {
                    alert("Start date must be before end date.");
                    // Reset the start date to the previous value
                    $(this).val('');
                } else {
                    if (selectedArea != 'null'){ //state(s) and condition selected
                        fillChart();
                    }
                }
                }
        }

        $(document).ready(function(){
            var minDate = new Date(2019, 12, 31);
            var maxDate = new Date(2022, 11, 31);
            $('#startDatePicker').datepicker({
                format: "MM yyyy",
                startView: "months", 
                minViewMode: "months",
                startDate: minDate,
                endDate: maxDate,
                autoclose: true,
                }).on('changeDate', function(e){
                        ensureSelected();
                    });
                
            $('#endDatePicker').datepicker({
                format: "MM yyyy",
                startView: "months", 
                minViewMode: "months",
                startDate: minDate,
                endDate: maxDate,
                autoclose: true
                }).on('changeDate', function(e){
                        ensureSelected();
                    });
        });
        
        //show chart
        async function fillChart(){
            try{
                startDate = $('#startDatePicker').datepicker('getDate');
                endDate = $('#endDatePicker').datepicker('getDate');
                
                startMonth = startDate.getMonth() +1;
                startYear = startDate.getFullYear();
                endMonth = endDate.getMonth()+1;
                endYear = endDate.getFullYear();
                
                await fetchData();
                
                placeholder.style.display = 'block'; //make chart visible if needed.
                placeholder1.style.display = 'block';
                
                let datasets = {}; //unemployment chart
                let datasets1 = {}; //crimerate chart
                
                datasets["unemployment"] = {
                label: "unemployment",
                data: [],
                backgroundColor: `rgba(0, 0, 0, 0)`, // Random color for each dataset
                borderColor: `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`, // Random color for each dataset
                borderWidth: 2
                };

                datasets1["crimerate"] = {
                label: "crimerate",
                data: [],
                backgroundColor: `rgba(0, 0, 0, 0)`, // Random color for each dataset
                borderColor: `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`, // Random color for each dataset
                borderWidth: 2
                };

                var uniqueMonths = [];
                
                data.rows.forEach(row => {
                    //const state = row[0];
                    const month = row[0];
                    const year = row[1];
                    const unemployment = row[2];
                    const crimerate = row[3];
                    
                    const monthyear = `${month}/${year}`;
                    if (!uniqueMonths.includes(monthyear)) {
                        uniqueMonths.push(monthyear);
                    }

                    datasets["unemployment"].data.push({
                        x: `${month}/${year}`,
                        y: unemployment
                    });

                    datasets1["crimerate"].data.push({
                        x: `${month}/${year}`,
                        y: crimerate
                    });
                });
                
                const datasetsArray = Object.values(datasets);
                const datasetsArray1 = Object.values(datasets1);

                if (lineChart) {
                    // Update chart data and options
                    lineChart.data.labels = uniqueMonths;
                    lineChart.data.datasets = datasetsArray;
                    lineChart.update();
                } else {
                    // Create a new chart
                    lineChart = new Chart(myChart, {
                        type: 'line',
                        data: {
                            labels: uniqueMonths,
                            datasets: datasetsArray
                        },
                        options: {
                            elements:{point:{radius: 1}},
                            scales: {
                                xAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Time' 
                                    }
                                }],
                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Unemployment'
                                    }
                                }]
                            }
                        }  //remove data point circles
                    });
                }

                if (lineChart1) {
                    // Update chart data and options
                    lineChart1.data.labels = uniqueMonths;
                    lineChart1.data.datasets = datasetsArray1;
                    lineChart1.update();
                } else {
                    // Create a new chart
                    lineChart1 = new Chart(myChart1, {
                        type: 'line',
                        data: {
                            labels: uniqueMonths,
                            datasets: datasetsArray1
                        },
                        options: {
                            elements:{point:{radius: 1}},
                            scales: {
                                xAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Time' 
                                    }
                                }],
                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Crime Rate'
                                    }
                                }]
                            }
                        
                        }  //remove data point circles
                    });
                }

            } catch (error) {
                console.error('Error filling chart:', error);
            }               
        }
        
        // Function to fetch data from the server and display it in the table
        async function fetchData() {
            try {
                //sharedString = JSON.stringify(sharedStates);
                const url = `/crimerate?sm=${startMonth}&sy=${startYear}&em=${endMonth}&ey=${endYear}&selectedArea=${selectedArea}`;

                const response = await fetch(url);
                data = await response.json();

                console.log(data);
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

    </script>
</body>

</html>