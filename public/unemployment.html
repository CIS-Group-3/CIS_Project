<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Unemployment</title>
    <link rel="stylesheet" href="unemployment.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="app.js"></script>
    <!-- for map -->
    <script src="mapdata.js"></script>
    <script src="usmap.js"></script>
    <script src="select.js"></script>
    <!-- for chart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!-- for datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/en-gb.min.js"></script>
</head>

<body>
<div class="container">
    <div id="option-holder">
        <div id="instructions">Select state(s) and time range to view the chart.</div>
        <div id="dateArea">
            <div id="startDate">
                select start date:
                <input type="text" class="form-control" id="startDatePicker" readonly>
            </div>
            <div id="endDate">
                select end date:
                <input type="text" class="form-control" id="endDatePicker" readonly>
            </div>
        </div>
    </div>

    <div id="my-map-holder">
        <div id="statesSelected">States selected: </div>
        <div id="map"></div>
    </div>

    <div id="chart-holder">
        <canvas id="myChart"></canvas>
    </div>
</div>

<script>
    var data;
    var startMonth;
    var startYear;
    var endMonth;
    var endYear;

    var sharedStates = [];

    var placeholder = document.getElementById('myChart');
    var myChart = placeholder.getContext('2d');

    var lineChart;

    $(document).ready(function () {
        $('#startDatePicker').datepicker({
            format: "MM yyyy",
            startView: "months",
            minViewMode: "months",
            autoclose: true,
        }).on('changeDate', function (e) {
            if ($('#endDatePicker').datepicker('getDate') != null && sharedStates.length >= 1) {
                var startDate = $('#startDatePicker').datepicker('getDate');
                var endDate = $('#endDatePicker').datepicker('getDate');
                if (startDate >= endDate) {
                    alert("Start date must be before end date.");
                    $(this).val('');
                } else {
                    if (sharedStates.length >= 1) {
                        fillChart();
                    }
                }
            }
        });

        $('#endDatePicker').datepicker({
            format: "MM yyyy",
            startView: "months",
            minViewMode: "months",
            autoclose: true
        }).on('changeDate', function (e) {
            if ($('#startDatePicker').datepicker('getDate') != null) {
                var startDate = $('#startDatePicker').datepicker('getDate');
                var endDate = $('#endDatePicker').datepicker('getDate');
                if (startDate >= endDate) {
                    alert("Start date must be before end date.");
                    $(this).val('');
                } else {
                    if (sharedStates.length >= 1) {
                        fillChart();
                    }
                }
            }
        });
    });

    // Function to fetch data from the server and display it in the table
    async function fetchData() {
        try {


            sharedString = JSON.stringify(sharedStates);
            const url = `/data?sm=${startMonth}&sy=${startYear}&em=${endMonth}&ey=${endYear}&states=${sharedString}`;

            const response = await fetch(url);
            data = await response.json();

            console.log(data);



        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Show chart
    async function fillChart() {
        try {

            const startDate = $('#startDatePicker').datepicker('getDate');
            const endDate = $('#endDatePicker').datepicker('getDate');

            startMonth = startDate.getMonth() + 1;
            startYear = startDate.getFullYear();
            endMonth = endDate.getMonth() + 1;
            endYear = endDate.getFullYear();
            console.log(startMonth, startYear);

            await fetchData();

            placeholder.style.display = 'block'; // Make chart visible if needed.

            let datasets = {}; // Groups data by state
            var uniqueMonths = [];

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const state = row[2];
                const year = row[1];
                const month = row[0];
                const rate = row[5];

                const monthyear = `${month}/${year}`;
                if (!uniqueMonths.includes(monthyear)) {
                    uniqueMonths.push(monthyear);
                }

                if (!datasets[state]) {
                    datasets[state] = {
                        label: state,
                        data: [],
                        backgroundColor: `rgba(0, 0, 0, 0)`, // Random color for each dataset
                        borderColor: `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`, // Random color for each dataset
                        borderWidth: 2
                    };
                }

                datasets[state].data.push({
                    x: `${month}/${year}`,
                    y: rate
                });
            }

            const datasetsArray = Object.values(datasets);

            if (lineChart) {
                // Update chart data and options
                lineChart.data.labels = uniqueMonths;
                lineChart.data.datasets = datasetsArray;
                lineChart.update();
            } else {
                // Create a new chart
                lineChart = new Chart(myChart, {
                    type: 'line',
                    data: {
                        labels: uniqueMonths,
                        datasets: datasetsArray
                    },
                    options: {
                        elements: {
                            point: {
                                radius: 0
                            }
                        } // Remove data point circles
                    }
                });
            }
        } catch (error) {
            console.error('Error filling chart:', error);
        }
    }

    function writeSharedStates(state) {
        sharedStates.push(state);

        document.getElementById('statesSelected').innerHTML = "States selected: ";
        if (sharedStates.length >= 1) {
            for (i = 0; i < sharedStates.length; i++) {
                document.getElementById('statesSelected').innerHTML += ` ${sharedStates[i]}`;
                if (i < sharedStates.length - 1) {
                    document.getElementById('statesSelected').innerHTML += `,`;
                }
            }
        }
        fillChart();
    }

    function removeSharedStates(state) {
        const index = sharedStates.indexOf(state);
        if (index != -1) {
            sharedStates.splice(index, 1);
        }

        document.getElementById('statesSelected').innerHTML = "States selected: ";
        if (sharedStates.length >= 1) {
            for (i = 0; i < sharedStates.length; i++) {
                document.getElementById('statesSelected').innerHTML += ` ${sharedStates[i]}`;
                if (i < sharedStates.length - 1) {
                    document.getElementById('statesSelected').innerHTML += `,`;
                }
            }
        }

        if (sharedStates.length >= 1) {
            fillChart();
        } else {
            placeholder.style.display = 'none';
        }
    }
</script>
</body>

</html>
