<!DOCTYPE html>
<html lang = "en">
<head>
	<meta charset = "UTF-8">
  	<title> Unemployment </title>
    <link rel="stylesheet" href="unemployment.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--for map-->
    <script src="mapdata.js"></script>
    <script src="usmap.js"></script>
    <script src="select.js"></script>
    <!--for chart-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!--for datepicker-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  	
</head>
<body>
    <div class="container">
        <div id="option-holder">
            <div id="instructions">instructions</div>
            <div id="dateArea">                
                <div id="startDate">
                    select start date:
                      <input type="text" class="form-control" id="startDatePicker" readonly>
                </div>
                <div id="endDate">
                    select end date:
                      <input type="text" class="form-control" id="endDatePicker" readonly>
                </div>

            </div>
        </div>

        <div id="my-map-holder">
            <div id="statesSelected">States selected: </div>
            <div id="map"></div>
        </div>
        
        <div id="chart-holder">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/en-gb.min.js"></script>


    <script>
        var data;
        var startMonth;
        var startYear;
        var endMonth;
        var endYear;

        var sharedStates=[];

        $(document).ready(function(){
            $('#startDatePicker').datepicker({
                format: "MM yyyy",
                startView: "months", 
                minViewMode: "months",
                autoclose: true,
                }).on('changeDate', function(e){
                    /*
                        var selectedDate = e.date;
                        var month = selectedDate.getMonth() + 1; // Month is zero-based
                        var year = selectedDate.getFullYear();
                        console.log("month: "+month +"year: "+year);
                    */
                    if ($('#endDatePicker').datepicker('getDate') != null){
                            fillChart();
                        }
                    });
                
            $('#endDatePicker').datepicker({
                format: "MM yyyy",
                startView: "months", 
                minViewMode: "months",
                autoclose: true
                }).on('changeDate', function(e){
                    /*
                        var selectedDate = e.date;
                        var month = selectedDate.getMonth() + 1; // Month is zero-based
                        var year = selectedDate.getFullYear();
                        console.log("month: "+month +"year: "+year);
                    */
                        if ($('#startDatePicker').datepicker('getDate') != null){
                            fillChart();
                        }
                    });
        });

        //show chart
        async function fillChart(){
            var myChart = document.getElementById('myChart').getContext('2d');

                var months = [];
                var years = [];
                /*
                for (var year = 2000; year <= 2022; year++) {
                    for (var month = 1; month <= 12; month++) {
                        months.push(month);
                        years.push(year);
                    }
                }
                */

                startDate = $('#startDatePicker').datepicker('getDate');
                endDate = $('#endDatePicker').datepicker('getDate');
                //console.log("date: "+startDate.getMonth());

                startMonth = startDate.getMonth() +1;
                startYear = startDate.getFullYear();
                endMonth = endDate.getMonth()+1;
                endYear = endDate.getFullYear();

                await fetchData();
                
                var myData = [];
                data.rows.forEach(row => {
                    months.push(row[2]);
                    years.push(row[1]);
                    myData.push(row[3]);
                });
                
                console.log(myData);
                console.log(years);

                var lineChart = new Chart(myChart, {
                    type: 'line',
                    data:{
                        labels: months.map((month, index) => `${month}/${years[index]}`),
                        datasets:[{
                            label: data.metaData[3].name,
                            data: myData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)', // Fill color
                            borderColor: 'rgba(54, 162, 235, 1)', // Line color
                            borderWidth: 2
                        }],
                        
                    },
                    options:{}
                });
                
        }
        

        // Function to fetch data from the server and display it in the table
        async function fetchData() {
            try {
                //console.log("ran now");
                sharedString = JSON.stringify(sharedStates);
                const url = `/data?sm=${startMonth}&sy=${startYear}&em=${endMonth}&ey=${endYear}&states=${sharedString}`;

                const response = await fetch(url);
                data = await response.json();

                console.log(data);
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function writeSharedStates(state){
            sharedStates.push(state);
            //console.log("shared: " +sharedStates);
        }


        // Fetch data when the page loads
        //window.onload = fetchData;
    </script>
</body>

</html>